<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>轮盘控制</title>
	<h4>注：需要触摸屏</h4>
	<style>
		body {
		    font-family: Arial, sans-serif;
		    text-align: center
		}
		
		* {
		    transition: all 0.3s ease
		}
		
		body {
		    font-family: Arial, sans-serif;
		    background-color: #EFF1F0
		}
		
		.container {
		    margin: 20px;
		    background-color: #ffffff;
		    border-radius: 30px;
		    padding: 20px
		}
		
		.button-group {
		    margin: 10px 0
		}
		
		.slider {
		    width: 200px
		}
		
		.button {
		    margin: auto;
		    padding: 5px;
		    font-size: 14px;
		    border-radius: 5px;
		    cursor: pointer
		}
		
		.btmgroup {
		    width: 100%;
		    display: -webkit-flex;
		    display: flex;
		    justify-content: space-around
		}
		
		input {
		    background-color: #ffffff;
		    border: none;
		    border-bottom: 2px solid #4a90e2;
		    padding: 8px 12px;
		    font-size: 16px;
		    transition: border-color 0.3s ease, box-shadow 0.3s ease;
		    width: 100%
		}
		
		input:focus {
		    border-bottom: 2px solid #66ccff;
		    outline: none
		}
		
		input:hover {
		    border-bottom: 2px solid #66ccff
		}
		
		button {
		    background-color: #f0f0f0;
		    border: none;
		    border-radius: 8px;
		    padding: 10px 16px;
		    font-size: 16px;
		    color: black;
		    cursor: pointer;
		    transition: all 0.3s ease;
		    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		    border-bottom: 2px solid #ffffff
		}
		
		button.active {
		    border-bottom: 2px solid #4a90e2;
		    outline: none;
		    color: black
		}
		
		button:active {
		    background-color: #66ccff;
		    border-bottom: 2px solid #ffffff;
		    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
		    color: white
		}
		
		#wheel-container {
		    position: relative;
		    width: 70vw;
		    height: 70vw;
		    margin: 50px auto;
		    border-radius: 50%;
		    border: 2px solid #000;
		    background-color: #eff1f0;
		    margin-bottom: 30px
		}
		
		#ws-status {
		    margin: 20px 0
		}
		
		#log {
		    margin-top: 20px;
		    height: 200px;
		    overflow-y: scroll;
		    border: 1px solid #eff1f0;
		    padding: 10px;
		    font-size: 12px;
		    background-color: #f9f9f9;
		    text-align: left
		}
		
	</style>
</head>
<body>
	<div class="container">
		<h3>触摸板控制</h3>
		<!-- 轮盘 -->
		<div id="wheel-container"></div>
		<hr />
		<a id="lnk" onclick="updateurl();"><button class="active">切换触摸板控制</button></a>
		<hr />
		<!-- WebSocket 状态显示 -->
		<div id="ws-status">设备状态: 未连接</div>
		<!-- WebSocket 控制按钮 -->
		<div class="btmgroup">
			<input type="text" id="wst-text" value="请稍等">
			<button id="control-btn">✧</button>
			<button onclick="shareurl()">✈</button>
		</div>
		<hr />
		<!-- 日志显示记得删 -->
		<div id="log"></div>
	</div>
	<script>
		let socket = null;
		let wscdtime = 100;
		//如果延迟还是比较大就把上面这个改大一点
		let isConnected = false;
		let wsStatusElement = document.getElementById('ws-status');
		let logElement = document.getElementById('log');
		let controlBtn = document.getElementById('control-btn');
		let wheelContainer = document.getElementById('wheel-container');
		let wstarget = document.getElementById('wst-text');
		const url = new URL(window.location.href);
		let tdip = url.searchParams.get('ip'); 
		let tdport = url.searchParams.get('port');
		if(!tdip){tdip="192.168.69.1";}
		if(!tdport){tdport="81";}
		
		
		window.onload = function(){
		    wstarget.value = (`${tdip}:${tdport}`);
		    }
		function shareurl(){
		    let sip = wstarget.value.split(":")[0];
		    let spp = wstarget.value.split(":")[1];
		    if(!spp){spp=81;}
		    logToConsole(`请将以下内容复制后粘贴给你想要分享控制权的对象（需要在同一网络下）：`);
		    logToConsole(`https://eterill.xyz/OhoVibe/?ip=${sip}&port=${spp}<br/><button onclick="copyToClip(\`https://eterill.xyz/OhoVibe/?ip=${sip}&port=${spp}\`);">点击复制</button>`);
		}
	    function updateurl(){
		    let sip = wstarget.value.split(":")[0];
		    let spp = wstarget.value.split(":")[1];
		    if(!spp){spp=81;}
		    document.getElementById('lnk').href=`./?ip=${sip}&port=${spp}`;
		}
		        /**
		 * 复制单行内容到粘贴板
		 * content : 需要复制的内容
		 * message : 复制完后的提示，不传则默认提示"复制成功"
		 */
		function copyToClip(content, message) {
		    var aux = document.createElement("input"); 
		    aux.setAttribute("value", content); 
		    document.body.appendChild(aux); 
		    aux.select();
		    document.execCommand("copy"); 
		    document.body.removeChild(aux);
		    if (message == null) {
		        alert("复制成功");
		    } else{
		        alert(message);
		    }
		}
		let isTouchingWheel = false;
		let isTouchingSlider = false;
		let isWSCooldown = false;
		
		// WebSocket连接和控制
		controlBtn.addEventListener('click', () => {
		    if (isConnected) {
		        socket.close();
		        isConnected = false;
		        wsStatusElement.textContent = '设备状态: 已断开';
		        
		    } else {
		        socket = new WebSocket("ws://"+wstarget.value);
		        socket.onopen = () => {
		            isConnected = true;
		            wsStatusElement.textContent = '设备状态: 已连接';
		            controlBtn.textContent = '断开';
		            logToConsole('WebSocket 已连接');
		        };
		        socket.onclose = () => {
		            isConnected = false;
		            wsStatusElement.textContent = '设备状态: 已断开';
		            
		            logToConsole('WebSocket 已断开');
		        };
		        socket.onerror = (error) => {
		            logToConsole('WebSocket 错误: ' + error);
		        };
		    }
		});
		
		// 记录日志
		function logToConsole(message) {
		    let logMessage = document.createElement('div');
		    logMessage.innerHTML = message;
		    logElement.appendChild(logMessage);
		    logElement.scrollTop = logElement.scrollHeight;
		}
		
		// 计算点击位置与中心的距离
		function getWheelValue(event) {
		    let rect = wheelContainer.getBoundingClientRect();
		    let centerX = rect.left + rect.width / 2;
		    let centerY = rect.top + rect.height / 2;
		    let touchX = event.clientX || event.changedTouches[0].clientX;
		    let touchY = event.clientY || event.changedTouches[0].clientY;
		
		    let dx = touchX - centerX;
		    let dy = touchY - centerY;
		    let distance = Math.sqrt(dx * dx + dy * dy);
		    let radius = rect.width / 2;
		    let percentage = Math.min(distance / radius, 1) * 100;
		    let sector = Math.floor((Math.atan2(dy, dx) + Math.PI) / (2 * Math.PI) * 11);
		
		    let value = Math.floor(percentage * 99.99); // 转换为0-9999的值
		    return { sector, value };
		}
		
		// 监听轮盘点击和触摸事件
		function handleWheelTouchMove(event) {
		    event.preventDefault();
		    if (isTouchingWheel && !isWSCooldown) {
		        let { sector, value } = getWheelValue(event);
		        let command = sector.toString().padStart(2, '0') + Math.round(value).toString().padStart(4, '0');
		        logToConsole(`发送指令: ${command}`);
		        isWSCooldown = true;
		        setTimeout(() => {isWSCooldown=false;},wscdtime);
		
		        if (isConnected && socket.readyState === WebSocket.OPEN) {
		            socket.send(command);
		            
		        } else {
		            logToConsole('未连接，发送失败');
		        }
		    }
		}
		
		
		// 轮盘触摸开始事件
		wheelContainer.addEventListener('touchstart', (event) => {
		    isTouchingWheel = true;
		    handleWheelTouchMove(event.touches[0]);
		});
		
		// 轮盘触摸移动事件
		wheelContainer.addEventListener('touchmove', handleWheelTouchMove);
		
		// 轮盘触摸结束事件
		wheelContainer.addEventListener('touchend', () => {
		    if (isTouchingWheel) {
		        isTouchingWheel = false;
		        let command = '110000';  // 触摸结束时发送110000
		        logToConsole(`发送指令: ${command}`);
		        isWSCooldown = true;
		        setTimeout(() => {isWSCooldown=false;},wscdtime);
		        if (isConnected && socket.readyState === WebSocket.OPEN) {
		            socket.send(command);
		            isWSCooldown = true;
		            setTimeout(() => {socket.send(command);},50);
		        } else {
		            logToConsole('未连接，发送失败');
		        }
		    }
		});
		
	</script>
	<p>&copy;EterIll & MyZhaZha, 2025.Partial rights reserved.</p>
</body>
</html>